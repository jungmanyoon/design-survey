<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„¤ë¬¸ ê²°ê³¼ ë³€í™˜ê¸°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');

        * { box-sizing: border-box; }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            margin: 0;
            padding: 30px;
            color: #333;
        }

        .container { max-width: 900px; margin: 0 auto; }

        h1 { color: white; text-align: center; margin-bottom: 10px; font-size: 28px; }

        .subtitle { color: #8892b0; text-align: center; margin-bottom: 30px; font-size: 14px; }

        .config-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .config-section h3 {
            margin: 0 0 15px 0;
            color: #003366;
            font-size: 16px;
        }

        .config-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
        }

        .config-row label {
            min-width: 120px;
            font-weight: 600;
            color: #555;
        }

        .config-row input[type="file"] { flex: 1; }

        .template-status {
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 13px;
        }

        .template-status.loaded { background: #d4edda; color: #155724; }
        .template-status.empty { background: #fff3cd; color: #856404; }

        .dropzone {
            background: white;
            border: 3px dashed #ccc;
            border-radius: 15px;
            padding: 50px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .dropzone:hover, .dropzone.dragover {
            border-color: #4CAF50;
            background: #f0fff0;
        }

        .dropzone-icon { font-size: 60px; margin-bottom: 15px; }
        .dropzone-text { font-size: 18px; color: #666; margin-bottom: 10px; }
        .dropzone-hint { font-size: 13px; color: #999; }

        .file-list {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .file-list.show { display: block; }

        .file-list h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .file-item .icon { font-size: 20px; margin-right: 12px; }
        .file-item .name { flex: 1; font-size: 14px; }
        .file-item .company { color: #4CAF50; font-weight: 600; margin-right: 15px; }
        .file-item .dci {
            background: #003366;
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }
        .file-item .remove {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
            margin-left: 10px;
        }

        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .progress-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .progress-section.show { display: block; }

        .progress-bar {
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text { text-align: center; font-size: 14px; color: #666; }

        .summary {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .summary.show { display: block; }
        .summary h3 { margin: 0 0 15px 0; color: #003366; }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .summary-table th, .summary-table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
        }

        .summary-table th { background: #003366; color: white; }
        .summary-table tr:nth-child(even) { background: #f8f9fa; }

        .info-box {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            color: #ccc;
            font-size: 13px;
        }

        .info-box h4 { color: white; margin: 0 0 10px 0; }
        .info-box ul { margin: 0; padding-left: 20px; }
        .info-box li { margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ì„¤ë¬¸ ê²°ê³¼ ë³€í™˜ê¸°</h1>
        <p class="subtitle">JSON íŒŒì¼ â†’ ì›ë³¸ ì„¤ë¬¸ì§€ì— ì‘ë‹µì´ ì±„ì›Œì§„ HTML + ë¶„ì„ Excel ëŒ€ì‹œë³´ë“œ</p>

        <div class="config-section">
            <h3>1ï¸âƒ£ ì„¤ë¬¸ì§€ í…œí”Œë¦¿ ì„ íƒ</h3>
            <div class="config-row">
                <label>ì„¤ë¬¸ì§€ HTML:</label>
                <input type="file" id="templateInput" accept=".html">
                <span class="template-status empty" id="templateStatus">í…œí”Œë¦¿ í•„ìš”</span>
            </div>
            <div style="font-size: 12px; color: #888; margin-top: 8px;">
                * ì„¤ë¬¸ì§€_í•œê¸€.html ë˜ëŠ” ì„¤ë¬¸ì§€_í•´ì™¸.html íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.
            </div>
        </div>

        <div class="dropzone" id="dropzone">
            <div class="dropzone-icon">ğŸ“</div>
            <div class="dropzone-text">2ï¸âƒ£ JSON íŒŒì¼ë“¤ì„ ì—¬ê¸°ì— ë“œë˜ê·¸ & ë“œë¡­</div>
            <div class="dropzone-hint">ë˜ëŠ” í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ (ì—¬ëŸ¬ íŒŒì¼ ê°€ëŠ¥)</div>
            <input type="file" id="fileInput" multiple accept=".json" style="display: none;">
        </div>

        <div class="file-list" id="fileList">
            <h3>ğŸ“‹ ì—…ë¡œë“œëœ JSON íŒŒì¼ (<span id="fileCount">0</span>ê°œ)</h3>
            <div id="fileItems"></div>
        </div>

        <div class="actions">
            <button class="btn btn-primary" id="btnConvert" disabled>
                ğŸ”„ ë³€í™˜ ë° ë‹¤ìš´ë¡œë“œ (ZIP)
            </button>
            <button class="btn btn-secondary" id="btnExcelOnly" disabled>
                ğŸ“Š Excel ë¶„ì„ë§Œ ë‹¤ìš´ë¡œë“œ
            </button>
        </div>

        <div class="progress-section" id="progressSection">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">ë³€í™˜ ì¤‘...</div>
        </div>

        <div class="summary" id="summary">
            <h3>ğŸ“ˆ DCI ì ìˆ˜ ìš”ì•½</h3>
            <table class="summary-table">
                <thead>
                    <tr>
                        <th>íšŒì‚¬ëª…</th>
                        <th>ìë™í™” (40%)</th>
                        <th>í‘œì¤€í™” (25%)</th>
                        <th>ë¦¬ë“œíƒ€ì„ (15%)</th>
                        <th>ITì‹œìŠ¤í…œ (20%)</th>
                        <th>DCI ì¢…í•©</th>
                    </tr>
                </thead>
                <tbody id="summaryBody"></tbody>
            </table>
        </div>

        <div class="info-box">
            <h4>ğŸ“Œ ì‚¬ìš© ë°©ë²•</h4>
            <ul>
                <li><strong>1ë‹¨ê³„:</strong> ì„¤ë¬¸ì§€ í…œí”Œë¦¿ HTML íŒŒì¼ ì„ íƒ (ì„¤ë¬¸ì§€_í•œê¸€.html)</li>
                <li><strong>2ë‹¨ê³„:</strong> ì‘ë‹µìë¡œë¶€í„° ë°›ì€ JSON íŒŒì¼ë“¤ ë“œë˜ê·¸ & ë“œë¡­</li>
                <li><strong>3ë‹¨ê³„:</strong> "ë³€í™˜ ë° ë‹¤ìš´ë¡œë“œ" í´ë¦­</li>
                <li>ê²°ê³¼: ê° ì—…ì²´ë³„ ì„¤ë¬¸ì§€ HTML + <strong>ì¢…í•©ë¶„ì„ Excel ëŒ€ì‹œë³´ë“œ</strong></li>
            </ul>
            <h4 style="margin-top: 15px;">ğŸ“Š Excel ë¶„ì„ ë‚´ìš©</h4>
            <ul>
                <li><strong>ëŒ€ì‹œë³´ë“œ:</strong> ì „ì²´ í˜„í™© ìš”ì•½, ì„ ì§„ì‚¬ ëŒ€ë¹„ Gap ë¶„ì„</li>
                <li><strong>ìƒì„¸ë¶„ì„:</strong> ì¹´í…Œê³ ë¦¬ë³„ ì ìˆ˜ ë° ìˆœìœ„</li>
                <li><strong>Gapë¶„ì„:</strong> í•­ëª©ë³„ ê°œì„  í•„ìš” ì˜ì—­ ì‹ë³„</li>
            </ul>
        </div>
    </div>

    <script>
        let surveyTemplate = null;
        let uploadedFiles = [];

        // ë²¤ì¹˜ë§ˆí¬ ê¸°ì¤€ì 
        const BENCHMARK = {
            globalTop: 4.4,      // ABB, Siemens
            domestic: 3.7,       // í˜„ëŒ€, íš¨ì„±
            average: 2.8         // ì—…ê³„ í‰ê· 
        };

        const templateInput = document.getElementById('templateInput');
        const templateStatus = document.getElementById('templateStatus');
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const fileItems = document.getElementById('fileItems');
        const fileCount = document.getElementById('fileCount');
        const btnConvert = document.getElementById('btnConvert');
        const btnExcelOnly = document.getElementById('btnExcelOnly');
        const progressSection = document.getElementById('progressSection');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const summary = document.getElementById('summary');
        const summaryBody = document.getElementById('summaryBody');

        templateInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file && file.name.endsWith('.html')) {
                surveyTemplate = await file.text();
                templateStatus.textContent = 'âœ… ' + file.name;
                templateStatus.classList.remove('empty');
                templateStatus.classList.add('loaded');
                updateButtons();
            }
        });

        dropzone.addEventListener('click', () => fileInput.click());
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });
        dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        async function handleFiles(files) {
            for (let file of files) {
                if (file.name.endsWith('.json')) {
                    try {
                        const text = await file.text();
                        const data = JSON.parse(text);
                        const companyName = data.companyInfo?.companyName || 'ë¯¸ì…ë ¥';

                        if (!uploadedFiles.some(f => f.companyName === companyName)) {
                            uploadedFiles.push({ fileName: file.name, companyName, data });
                        }
                    } catch (err) {
                        alert(`íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: ${file.name}`);
                    }
                }
            }
            updateUI();
        }

        function updateUI() {
            fileCount.textContent = uploadedFiles.length;

            if (uploadedFiles.length > 0) {
                fileList.classList.add('show');
                fileItems.innerHTML = uploadedFiles.map((file, i) => {
                    const dci = file.data.scores?.dci || 0;
                    return `
                        <div class="file-item">
                            <span class="icon">ğŸ“„</span>
                            <span class="name">${file.fileName}</span>
                            <span class="company">${file.companyName}</span>
                            <span class="dci">DCI ${dci.toFixed(2)}ì </span>
                            <button class="remove" onclick="removeFile(${i})">âœ•</button>
                        </div>
                    `;
                }).join('');
                updateSummary();
            } else {
                fileList.classList.remove('show');
                summary.classList.remove('show');
            }
            updateButtons();
        }

        function updateButtons() {
            const ready = surveyTemplate && uploadedFiles.length > 0;
            btnConvert.disabled = !ready;
            btnExcelOnly.disabled = uploadedFiles.length === 0;
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateUI();
        }

        function updateSummary() {
            summary.classList.add('show');
            summaryBody.innerHTML = uploadedFiles.map(file => {
                const s = file.data.scores || {};
                return `
                    <tr>
                        <td><strong>${file.companyName}</strong></td>
                        <td>${(s.automation?.avg || 0).toFixed(1)}</td>
                        <td>${(s.standardization?.avg || 0).toFixed(1)}</td>
                        <td>${(s.leadtime?.avg || 0).toFixed(1)}</td>
                        <td>${(s.it_system?.avg || 0).toFixed(1)}</td>
                        <td><strong>${(s.dci || 0).toFixed(2)}</strong></td>
                    </tr>
                `;
            }).join('');
        }

        // =====================================================
        // Excel ìƒì„± - ExcelJSë¡œ ì „ë¬¸ì ì¸ ëŒ€ì‹œë³´ë“œ ìƒì„±
        // =====================================================
        async function generateExcelDashboard() {
            const workbook = new ExcelJS.Workbook();
            workbook.creator = 'ì„¤ê³„í˜ì‹ TFT';
            workbook.created = new Date();

            // ìƒ‰ìƒ ì •ì˜
            const colors = {
                headerBg: '003366',
                headerText: 'FFFFFF',
                excellent: '28A745',    // 4.0 ì´ìƒ (ì´ˆë¡)
                good: '17A2B8',         // 3.0~4.0 (íŒŒë‘)
                warning: 'FFC107',      // 2.0~3.0 (ë…¸ë‘)
                danger: 'DC3545',       // 2.0 ë¯¸ë§Œ (ë¹¨ê°•)
                lightGray: 'F8F9FA',
                borderColor: 'DEE2E6'
            };

            // ì ìˆ˜ë³„ ìƒ‰ìƒ ë°˜í™˜
            function getScoreColor(score) {
                if (score >= 4.0) return colors.excellent;
                if (score >= 3.0) return colors.good;
                if (score >= 2.0) return colors.warning;
                return colors.danger;
            }

            // ì ìˆ˜ë³„ ë“±ê¸‰
            function getGrade(score) {
                if (score >= 4.5) return 'S';
                if (score >= 4.0) return 'A';
                if (score >= 3.5) return 'B+';
                if (score >= 3.0) return 'B';
                if (score >= 2.5) return 'C+';
                if (score >= 2.0) return 'C';
                return 'D';
            }

            // ë°ì´í„° ì¤€ë¹„
            const companies = uploadedFiles.map(f => ({
                name: f.companyName,
                automation: f.data.scores?.automation?.avg || 0,
                standardization: f.data.scores?.standardization?.avg || 0,
                leadtime: f.data.scores?.leadtime?.avg || 0,
                it_system: f.data.scores?.it_system?.avg || 0,
                dci: f.data.scores?.dci || 0
            })).sort((a, b) => b.dci - a.dci);

            // =====================================================
            // Sheet 1: ëŒ€ì‹œë³´ë“œ
            // =====================================================
            const dashboardSheet = workbook.addWorksheet('ëŒ€ì‹œë³´ë“œ', {
                properties: { tabColor: { argb: '003366' } }
            });

            // ì œëª©
            dashboardSheet.mergeCells('A1:H1');
            const titleCell = dashboardSheet.getCell('A1');
            titleCell.value = 'ğŸ“Š ì„¤ê³„ ì—­ëŸ‰ ë²¤ì¹˜ë§ˆí‚¹ ë¶„ì„ ëŒ€ì‹œë³´ë“œ';
            titleCell.font = { name: 'ë§‘ì€ ê³ ë”•', size: 20, bold: true, color: { argb: '003366' } };
            titleCell.alignment = { horizontal: 'center', vertical: 'middle' };
            dashboardSheet.getRow(1).height = 40;

            // ë¶„ì„ì¼ì
            dashboardSheet.mergeCells('A2:H2');
            const dateCell = dashboardSheet.getCell('A2');
            dateCell.value = `ë¶„ì„ì¼: ${new Date().toLocaleDateString('ko-KR')} | ë¶„ì„ ëŒ€ìƒ: ${companies.length}ê°œ íšŒì‚¬`;
            dateCell.font = { name: 'ë§‘ì€ ê³ ë”•', size: 11, color: { argb: '666666' } };
            dateCell.alignment = { horizontal: 'center' };

            // ë²¤ì¹˜ë§ˆí¬ ê¸°ì¤€ ë°•ìŠ¤
            dashboardSheet.mergeCells('A4:H4');
            dashboardSheet.getCell('A4').value = 'â–  ë²¤ì¹˜ë§ˆí¬ ê¸°ì¤€';
            dashboardSheet.getCell('A4').font = { name: 'ë§‘ì€ ê³ ë”•', size: 12, bold: true };

            dashboardSheet.getCell('A5').value = 'ê¸€ë¡œë²Œ Top (ABB, Siemens)';
            dashboardSheet.getCell('B5').value = BENCHMARK.globalTop;
            dashboardSheet.getCell('B5').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colors.excellent } };
            dashboardSheet.getCell('B5').font = { color: { argb: 'FFFFFF' }, bold: true };

            dashboardSheet.getCell('C5').value = 'êµ­ë‚´ ì„ ë‘ (í˜„ëŒ€, íš¨ì„±)';
            dashboardSheet.getCell('D5').value = BENCHMARK.domestic;
            dashboardSheet.getCell('D5').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colors.good } };
            dashboardSheet.getCell('D5').font = { color: { argb: 'FFFFFF' }, bold: true };

            dashboardSheet.getCell('E5').value = 'ì—…ê³„ í‰ê· ';
            dashboardSheet.getCell('F5').value = BENCHMARK.average;
            dashboardSheet.getCell('F5').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colors.warning } };
            dashboardSheet.getCell('F5').font = { bold: true };

            // DCI ì¢…í•© ìˆœìœ„í‘œ
            dashboardSheet.mergeCells('A7:H7');
            dashboardSheet.getCell('A7').value = 'â–  DCI ì¢…í•© ìˆœìœ„ (Design Competitiveness Index)';
            dashboardSheet.getCell('A7').font = { name: 'ë§‘ì€ ê³ ë”•', size: 12, bold: true };

            // í—¤ë”
            const headerRow = dashboardSheet.getRow(8);
            const headers = ['ìˆœìœ„', 'íšŒì‚¬ëª…', 'ìë™í™”(40%)', 'í‘œì¤€í™”(25%)', 'ë¦¬ë“œíƒ€ì„(15%)', 'ITì‹œìŠ¤í…œ(20%)', 'DCI ì ìˆ˜', 'ë“±ê¸‰'];
            headers.forEach((h, i) => {
                const cell = headerRow.getCell(i + 1);
                cell.value = h;
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colors.headerBg } };
                cell.font = { name: 'ë§‘ì€ ê³ ë”•', size: 11, bold: true, color: { argb: colors.headerText } };
                cell.alignment = { horizontal: 'center', vertical: 'middle' };
                cell.border = {
                    top: { style: 'thin', color: { argb: colors.borderColor } },
                    bottom: { style: 'thin', color: { argb: colors.borderColor } },
                    left: { style: 'thin', color: { argb: colors.borderColor } },
                    right: { style: 'thin', color: { argb: colors.borderColor } }
                };
            });
            headerRow.height = 25;

            // ë°ì´í„°
            companies.forEach((company, idx) => {
                const row = dashboardSheet.getRow(9 + idx);
                const rowData = [
                    idx + 1,
                    company.name,
                    company.automation.toFixed(2),
                    company.standardization.toFixed(2),
                    company.leadtime.toFixed(2),
                    company.it_system.toFixed(2),
                    company.dci.toFixed(2),
                    getGrade(company.dci)
                ];

                rowData.forEach((val, i) => {
                    const cell = row.getCell(i + 1);
                    cell.value = val;
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                    cell.border = {
                        top: { style: 'thin', color: { argb: colors.borderColor } },
                        bottom: { style: 'thin', color: { argb: colors.borderColor } },
                        left: { style: 'thin', color: { argb: colors.borderColor } },
                        right: { style: 'thin', color: { argb: colors.borderColor } }
                    };

                    // ì ìˆ˜ ì…€ì— ì¡°ê±´ë¶€ ìƒ‰ìƒ
                    if (i >= 2 && i <= 6) {
                        const score = parseFloat(val);
                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: getScoreColor(score) } };
                        cell.font = { color: { argb: score >= 2.0 && score < 3.0 ? '000000' : 'FFFFFF' }, bold: i === 6 };
                    }

                    // ë“±ê¸‰ ì…€ ê°•ì¡°
                    if (i === 7) {
                        cell.font = { bold: true, size: 12 };
                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: getScoreColor(company.dci) } };
                        cell.font = { color: { argb: company.dci >= 2.0 && company.dci < 3.0 ? '000000' : 'FFFFFF' }, bold: true };
                    }
                });

                // ì§ìˆ˜í–‰ ë°°ê²½
                if (idx % 2 === 1) {
                    for (let i = 1; i <= 2; i++) {
                        row.getCell(i).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colors.lightGray } };
                    }
                }

                row.height = 22;
            });

            // ì»¬ëŸ¼ ë„ˆë¹„
            dashboardSheet.columns = [
                { width: 8 }, { width: 18 }, { width: 14 }, { width: 14 },
                { width: 14 }, { width: 14 }, { width: 12 }, { width: 8 }
            ];

            // =====================================================
            // Sheet 2: Gap ë¶„ì„
            // =====================================================
            const gapSheet = workbook.addWorksheet('Gapë¶„ì„', {
                properties: { tabColor: { argb: 'DC3545' } }
            });

            gapSheet.mergeCells('A1:G1');
            gapSheet.getCell('A1').value = 'ğŸ“‰ ì„ ì§„ì‚¬ ëŒ€ë¹„ Gap ë¶„ì„ (ê¸€ë¡œë²Œ Top ê¸°ì¤€: 4.4ì )';
            gapSheet.getCell('A1').font = { name: 'ë§‘ì€ ê³ ë”•', size: 16, bold: true, color: { argb: '003366' } };
            gapSheet.getRow(1).height = 35;

            // Gap í—¤ë”
            const gapHeaderRow = gapSheet.getRow(3);
            const gapHeaders = ['íšŒì‚¬ëª…', 'ìë™í™” Gap', 'í‘œì¤€í™” Gap', 'ë¦¬ë“œíƒ€ì„ Gap', 'ITì‹œìŠ¤í…œ Gap', 'DCI Gap', 'ë‹¬ì„±ë¥ (%)'];
            gapHeaders.forEach((h, i) => {
                const cell = gapHeaderRow.getCell(i + 1);
                cell.value = h;
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colors.headerBg } };
                cell.font = { name: 'ë§‘ì€ ê³ ë”•', size: 11, bold: true, color: { argb: colors.headerText } };
                cell.alignment = { horizontal: 'center', vertical: 'middle' };
                cell.border = {
                    top: { style: 'thin' }, bottom: { style: 'thin' },
                    left: { style: 'thin' }, right: { style: 'thin' }
                };
            });

            companies.forEach((company, idx) => {
                const row = gapSheet.getRow(4 + idx);
                const gapData = [
                    company.name,
                    (company.automation - BENCHMARK.globalTop).toFixed(2),
                    (company.standardization - BENCHMARK.globalTop).toFixed(2),
                    (company.leadtime - BENCHMARK.globalTop).toFixed(2),
                    (company.it_system - BENCHMARK.globalTop).toFixed(2),
                    (company.dci - BENCHMARK.globalTop).toFixed(2),
                    ((company.dci / BENCHMARK.globalTop) * 100).toFixed(1)
                ];

                gapData.forEach((val, i) => {
                    const cell = row.getCell(i + 1);
                    cell.value = val;
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                    cell.border = {
                        top: { style: 'thin' }, bottom: { style: 'thin' },
                        left: { style: 'thin' }, right: { style: 'thin' }
                    };

                    // Gap ê°’ì— ìƒ‰ìƒ (ìŒìˆ˜ëŠ” ë¹¨ê°•, ì–‘ìˆ˜ëŠ” ì´ˆë¡)
                    if (i >= 1 && i <= 5) {
                        const gap = parseFloat(val);
                        if (gap < 0) {
                            cell.font = { color: { argb: colors.danger }, bold: true };
                        } else {
                            cell.font = { color: { argb: colors.excellent }, bold: true };
                        }
                    }

                    // ë‹¬ì„±ë¥  ìƒ‰ìƒ
                    if (i === 6) {
                        const rate = parseFloat(val);
                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: getScoreColor(rate / 25) } };
                        cell.font = { color: { argb: rate < 75 ? 'FFFFFF' : '000000' }, bold: true };
                    }
                });
            });

            gapSheet.columns = [
                { width: 18 }, { width: 14 }, { width: 14 }, { width: 14 },
                { width: 14 }, { width: 12 }, { width: 12 }
            ];

            // ê°œì„  ìš°ì„ ìˆœìœ„ ì„¹ì…˜
            const priorityStartRow = 4 + companies.length + 2;
            gapSheet.mergeCells(`A${priorityStartRow}:G${priorityStartRow}`);
            gapSheet.getCell(`A${priorityStartRow}`).value = 'â–  ì¹´í…Œê³ ë¦¬ë³„ í‰ê·  Gap (ê°œì„  ìš°ì„ ìˆœìœ„)';
            gapSheet.getCell(`A${priorityStartRow}`).font = { name: 'ë§‘ì€ ê³ ë”•', size: 12, bold: true };

            const avgGaps = [
                { name: 'ì„¤ê³„ ìë™í™” (40%)', gap: companies.reduce((s, c) => s + c.automation, 0) / companies.length - BENCHMARK.globalTop },
                { name: 'ì„¤ê³„ í‘œì¤€í™” (25%)', gap: companies.reduce((s, c) => s + c.standardization, 0) / companies.length - BENCHMARK.globalTop },
                { name: 'ë¦¬ë“œíƒ€ì„ (15%)', gap: companies.reduce((s, c) => s + c.leadtime, 0) / companies.length - BENCHMARK.globalTop },
                { name: 'ITì‹œìŠ¤í…œ (20%)', gap: companies.reduce((s, c) => s + c.it_system, 0) / companies.length - BENCHMARK.globalTop }
            ].sort((a, b) => a.gap - b.gap);

            avgGaps.forEach((item, idx) => {
                const row = gapSheet.getRow(priorityStartRow + 2 + idx);
                row.getCell(1).value = `${idx + 1}ìˆœìœ„`;
                row.getCell(2).value = item.name;
                row.getCell(3).value = item.gap.toFixed(2);
                row.getCell(3).font = { color: { argb: colors.danger }, bold: true };
                row.getCell(4).value = 'â† ìš°ì„  ê°œì„  í•„ìš”';
                row.getCell(4).font = { color: { argb: '666666' } };
            });

            // =====================================================
            // Sheet 3: ìƒì„¸ ë°ì´í„°
            // =====================================================
            const detailSheet = workbook.addWorksheet('ìƒì„¸ë°ì´í„°', {
                properties: { tabColor: { argb: '17A2B8' } }
            });

            detailSheet.mergeCells('A1:F1');
            detailSheet.getCell('A1').value = 'ğŸ“‹ ì „ì²´ ì‘ë‹µ ë°ì´í„° (ì •ë ¬: DCI ì ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ)';
            detailSheet.getCell('A1').font = { name: 'ë§‘ì€ ê³ ë”•', size: 16, bold: true, color: { argb: '003366' } };
            detailSheet.getRow(1).height = 35;

            // í†µê³„ ìš”ì•½
            const avgDCI = companies.reduce((s, c) => s + c.dci, 0) / companies.length;
            const maxDCI = Math.max(...companies.map(c => c.dci));
            const minDCI = Math.min(...companies.map(c => c.dci));

            detailSheet.getCell('A3').value = 'í‰ê·  DCI:';
            detailSheet.getCell('B3').value = avgDCI.toFixed(2);
            detailSheet.getCell('B3').font = { bold: true };

            detailSheet.getCell('C3').value = 'ìµœê³  DCI:';
            detailSheet.getCell('D3').value = maxDCI.toFixed(2);
            detailSheet.getCell('D3').font = { bold: true, color: { argb: colors.excellent } };

            detailSheet.getCell('E3').value = 'ìµœì € DCI:';
            detailSheet.getCell('F3').value = minDCI.toFixed(2);
            detailSheet.getCell('F3').font = { bold: true, color: { argb: colors.danger } };

            // ìƒì„¸ ë°ì´í„° í…Œì´ë¸”
            const detailHeaderRow = detailSheet.getRow(5);
            const detailHeaders = ['ìˆœìœ„', 'íšŒì‚¬ëª…', 'ìë™í™”', 'í‘œì¤€í™”', 'ë¦¬ë“œíƒ€ì„', 'ITì‹œìŠ¤í…œ', 'DCI', 'ë“±ê¸‰', 'ì„ ì§„ì‚¬ëŒ€ë¹„'];
            detailHeaders.forEach((h, i) => {
                const cell = detailHeaderRow.getCell(i + 1);
                cell.value = h;
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colors.headerBg } };
                cell.font = { name: 'ë§‘ì€ ê³ ë”•', size: 10, bold: true, color: { argb: colors.headerText } };
                cell.alignment = { horizontal: 'center' };
                cell.border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
            });

            companies.forEach((company, idx) => {
                const row = detailSheet.getRow(6 + idx);
                const rowData = [
                    idx + 1,
                    company.name,
                    company.automation.toFixed(2),
                    company.standardization.toFixed(2),
                    company.leadtime.toFixed(2),
                    company.it_system.toFixed(2),
                    company.dci.toFixed(2),
                    getGrade(company.dci),
                    `${((company.dci / BENCHMARK.globalTop) * 100).toFixed(0)}%`
                ];

                rowData.forEach((val, i) => {
                    const cell = row.getCell(i + 1);
                    cell.value = val;
                    cell.alignment = { horizontal: 'center' };
                    cell.border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
                });
            });

            detailSheet.columns = [
                { width: 6 }, { width: 16 }, { width: 10 }, { width: 10 },
                { width: 10 }, { width: 10 }, { width: 8 }, { width: 6 }, { width: 10 }
            ];

            // Excel ë²„í¼ ìƒì„±
            const buffer = await workbook.xlsx.writeBuffer();
            return buffer;
        }

        // ë³€í™˜
        btnConvert.addEventListener('click', async () => {
            if (!surveyTemplate || uploadedFiles.length === 0) return;

            progressSection.classList.add('show');
            progressFill.style.width = '0%';

            try {
                const zip = new JSZip();
                const total = uploadedFiles.length;

                for (let i = 0; i < total; i++) {
                    const file = uploadedFiles[i];
                    progressText.textContent = `${file.companyName} ë³€í™˜ ì¤‘... (${i + 1}/${total})`;
                    progressFill.style.width = `${((i + 1) / (total + 1)) * 100}%`;

                    const html = generateFilledHTML(surveyTemplate, file.data);
                    zip.file(`${file.companyName}_ì„¤ë¬¸ê²°ê³¼.html`, html);
                    await sleep(50);
                }

                // Excel ìƒì„±
                progressText.textContent = 'Excel ë¶„ì„ ëŒ€ì‹œë³´ë“œ ìƒì„± ì¤‘...';
                const excelBuffer = await generateExcelDashboard();
                zip.file('DCI_ë¶„ì„_ëŒ€ì‹œë³´ë“œ.xlsx', excelBuffer);

                progressFill.style.width = '100%';
                progressText.textContent = 'ZIP ìƒì„± ì¤‘...';

                const content = await zip.generateAsync({ type: 'blob' });
                const dateStr = new Date().toISOString().slice(0, 10);
                downloadBlob(content, `ì„¤ë¬¸ê²°ê³¼_${dateStr}.zip`);

                progressText.textContent = 'âœ… ì™„ë£Œ!';
                setTimeout(() => progressSection.classList.remove('show'), 2000);

            } catch (err) {
                alert('ì˜¤ë¥˜: ' + err.message);
                console.error(err);
                progressSection.classList.remove('show');
            }
        });

        // Excelë§Œ ë‹¤ìš´ë¡œë“œ
        btnExcelOnly.addEventListener('click', async () => {
            try {
                progressSection.classList.add('show');
                progressText.textContent = 'Excel ë¶„ì„ ëŒ€ì‹œë³´ë“œ ìƒì„± ì¤‘...';
                progressFill.style.width = '50%';

                const buffer = await generateExcelDashboard();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                downloadBlob(blob, `DCI_ë¶„ì„_ëŒ€ì‹œë³´ë“œ_${new Date().toISOString().slice(0, 10)}.xlsx`);

                progressFill.style.width = '100%';
                progressText.textContent = 'âœ… ì™„ë£Œ!';
                setTimeout(() => progressSection.classList.remove('show'), 2000);
            } catch (err) {
                alert('ì˜¤ë¥˜: ' + err.message);
                console.error(err);
                progressSection.classList.remove('show');
            }
        });

        // í•µì‹¬: ì›ë³¸ ì„¤ë¬¸ì§€ HTMLì— JSON ë°ì´í„° ì±„ì›Œë„£ê¸° (HTML ì§ì ‘ ìˆ˜ì • ë°©ì‹)
        function generateFilledHTML(template, jsonData) {
            const companyName = jsonData.companyInfo?.companyName || 'ë¯¸ì…ë ¥';
            const surveyDate = jsonData.companyInfo?.surveyDate || '';
            const responses = jsonData.responses || {};
            const textInputs = jsonData.textInputs || {};
            const staffCounts = jsonData.staffCounts || {};
            const checkboxResponses = jsonData.checkboxResponses || {};
            const remarks = jsonData.remarks || [];
            const scores = jsonData.scores || {};

            // DOMParserë¡œ HTML íŒŒì‹±
            const parser = new DOMParser();
            const doc = parser.parseFromString(template, 'text/html');

            // 1. ì ìˆ˜ ë°°ë„ˆ ì¶”ê°€
            const scoreBanner = doc.createElement('div');
            scoreBanner.style.cssText = 'background: linear-gradient(135deg, #003366, #004080); color: white; padding: 15px 20px; margin: 0 auto 10px; max-width: 210mm; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;';
            scoreBanner.innerHTML = `
                <div style="font-size: 18px; font-weight: bold;">ğŸ“‹ ${companyName} ì„¤ë¬¸ ê²°ê³¼</div>
                <div style="display: flex; gap: 15px; font-size: 13px;">
                    <span>ìë™í™”: <strong>${(scores.automation?.avg || 0).toFixed(1)}</strong></span>
                    <span>í‘œì¤€í™”: <strong>${(scores.standardization?.avg || 0).toFixed(1)}</strong></span>
                    <span>L/T: <strong>${(scores.leadtime?.avg || 0).toFixed(1)}</strong></span>
                    <span>IT: <strong>${(scores.it_system?.avg || 0).toFixed(1)}</strong></span>
                    <span style="color: #ffd700; font-size: 16px;">DCI: <strong>${(scores.dci || 0).toFixed(2)}</strong></span>
                </div>`;
            doc.body.insertBefore(scoreBanner, doc.body.firstChild);

            // 2. ì œëª© ë³€ê²½
            const titleEl = doc.querySelector('title');
            if (titleEl) titleEl.textContent = `ì„¤ë¬¸ê²°ê³¼ - ${companyName}`;

            // 3. íšŒì‚¬ëª…/ë‚ ì§œ ì…ë ¥ (ì–¸ì–´ ë…ë¦½ì  ì…€ë ‰í„°)
            const dateInput = doc.querySelector('input[placeholder="2025.12.XX"]');
            const companyInput = doc.querySelector('input[data-placeholder-kr="ê¸°ì—…ëª…"]') ||
                                 doc.querySelector('input[placeholder="ê¸°ì—…ëª…"]') ||
                                 doc.querySelector('input[placeholder="Company Name"]');
            if (dateInput) dateInput.setAttribute('value', surveyDate);
            if (companyInput) companyInput.setAttribute('value', companyName);

            // 4. ë¼ë””ì˜¤ ë²„íŠ¼ ì§ì ‘ ì²´í¬ (í•µì‹¬!)
            for (const [name, resp] of Object.entries(responses)) {
                if (name.startsWith('na_')) {
                    // í•´ë‹¹ì—†ìŒ ì²´í¬ë°•ìŠ¤
                    const cb = doc.querySelector(`input[name="${name}"]`);
                    if (cb) cb.setAttribute('checked', 'checked');
                } else {
                    // ë¼ë””ì˜¤ ë²„íŠ¼
                    const radio = doc.querySelector(`input[name="${name}"][value="${resp.value}"]`);
                    if (radio) radio.setAttribute('checked', 'checked');
                }
            }

            // 5. ì²´í¬ë°•ìŠ¤ ì§ì ‘ ì²´í¬
            for (const [section, labels] of Object.entries(checkboxResponses)) {
                labels.forEach(label => {
                    const checkboxes = doc.querySelectorAll('input[type="checkbox"]');
                    const normalizedLabel = label.replace(/\s/g, '');
                    checkboxes.forEach(cb => {
                        const cbLabel = cb.parentElement?.textContent?.trim().replace(/\s/g, '');
                        if (cbLabel && cbLabel.includes(normalizedLabel)) {
                            cb.setAttribute('checked', 'checked');
                        }
                    });
                });
            }

            // 6. í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œ ê°’ ì„¤ì • (ì–¸ì–´ ë…ë¦½ì  ë§¤ì¹­)
            for (const [placeholder, value] of Object.entries(textInputs)) {
                // data-placeholder-kr ì†ì„± ë˜ëŠ” placeholder ì†ì„±ìœ¼ë¡œ ê²€ìƒ‰
                const input = doc.querySelector(`input[data-placeholder-kr="${placeholder}"]`) ||
                              doc.querySelector(`input[placeholder="${placeholder}"]`);
                if (input) input.setAttribute('value', value);
            }

            // 7. ì¸ì›ìˆ˜ ì…ë ¥ - ê° íŒ€ë³„ë¡œ ì˜¬ë°”ë¥¸ ì…ë ¥ì¹¸ ë§¤í•‘ (ì–¸ì–´ ë…ë¦½ì )
            const teamTextareas = doc.querySelectorAll('textarea.team-name');
            teamTextareas.forEach(ta => {
                // í…œí”Œë¦¿ HTMLì˜ ì›ë³¸ í…ìŠ¤íŠ¸(í•œê¸€)ë¥¼ ìš°ì„  ì‚¬ìš©
                const teamName = ta.textContent?.trim() || ta.value?.trim() || ta.getAttribute('placeholder');
                if (staffCounts[teamName]) {
                    const td = ta.closest('td');
                    if (td) {
                        // í•´ë‹¹ íŒ€ textarea ë‹¤ìŒì˜ 2ê°œ tdì—ì„œ ìˆ«ì ì…ë ¥ê°’ ì„¤ì •
                        const nextTd1 = td.nextElementSibling;
                        const nextTd2 = nextTd1 ? nextTd1.nextElementSibling : null;

                        const internalInput = nextTd1 ? nextTd1.querySelector('input[type="number"]') : null;
                        const externalInput = nextTd2 ? nextTd2.querySelector('input[type="number"]') : null;

                        if (internalInput) internalInput.setAttribute('value', staffCounts[teamName].internal || '');
                        if (externalInput) externalInput.setAttribute('value', staffCounts[teamName].external || '');
                    }
                }
            });

            // 8. ë¹„ê³ /ì˜ê²¬ ì…ë ¥
            if (remarks.length > 0) {
                const remarkTextareas = doc.querySelectorAll('.remarks-box textarea');
                remarkTextareas.forEach((ta, idx) => {
                    if (remarks[idx]) ta.textContent = remarks[idx];
                });
            }

            // 9. ì½ê¸° ì „ìš© ìŠ¤íƒ€ì¼ ì¶”ê°€
            const readOnlyStyle = doc.createElement('style');
            readOnlyStyle.textContent = `
                input, textarea, select { pointer-events: none; background-color: #f8f9fa; }
                input[type="radio"]:checked + span, input[type="checkbox"]:checked + span { font-weight: bold; }
            `;
            doc.head.appendChild(readOnlyStyle);

            // HTML ë¬¸ìì—´ë¡œ ë°˜í™˜
            return '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
        }

        function downloadBlob(blob, fileName) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
